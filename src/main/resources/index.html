<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>DPS</title>
    <link
            href="styles.css"
            rel="stylesheet"
            type="text/css"/>
    <link
            rel="stylesheet"
            href="./lib/SpoqaHanSansNeo.min.css"/>
<!--    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>-->
    <script src="./lib/vue.min.js"></script>
    <script src="./lib/lucide.min.js"></script>
</head>

<body>
<div class="container">
    <div id="app"></div>
</div>

<script src="./js/util.js"></script>
<script src="./js/dps.js"></script>
<script src="./components/headerArea.js"></script>
<script src="./components/meterArea.js"></script>
<script src="./components/detailArea.js"></script>
<script src="./components/updateArea.js"></script>
<script src="./components/settingArea.js"></script>

<script>
  const {createApp, ref, onMounted, onUnmounted, watch} = Vue;

  const app = createApp({
    components: {
      HeaderArea: window.HeaderArea,
      MeterArea: window.MeterArea,
      DetailArea: window.DetailArea,
      UpdateArea: window.UpdateArea,
      SettingArea: window.SettingArea,
    },
    setup() {
      // detail ref
      const isCollapse = ref(false);
      const isDetailOpen = ref(false);
      const detailRowId = ref("");
      const dpsDatas = ref([]);
      const targetName = ref("");
      let intervalId = null;    // dps polling id

      // drag ref
      const isDragging = ref(false);
      const startX = ref(0);
      const startY = ref(0);
      const initialStageX = ref(0);
      const initialStageY = ref(0);

      // battletime ref
      const fightState = ref("state-grace");
      const lastChangedAt = ref(0);
      const lastBattleTimeMs = ref(null);
      const battleTimeMs = ref(null);

      // setting ref
      const isSetting = ref(false);

      // 리셋버튼 이벤트
      const resetClick = () => {
        isCollapse.value = false;
        isDetailOpen.value = false;
        detailRowId.value = "";
        dpsDatas.value = [];
        targetName.value = "";

        fightState.value = "state-grace";
        lastBattleTimeMs.value = null;
        lastChangedAt.value = 0;
        window.javaBridge?.resetDps();
      };

      // 리스트 정렬변환 클릭 이벤트
      const collapseClick = () => {
        console.log(isCollapse.value)
        isCollapse.value = !isCollapse.value;
      };

      //리스트에서 유저클릭시 이벤트
      const onClickUserRow = (row) => {
        if (row.id) {
          detailRowId.value = row.id;
          isDetailOpen.value = true;
        }
      }

      // 창 이동 이벤트
      const handleMouseDown = (e) => {
        isDragging.value = true;
        startX.value = e.screenX;
        startY.value = e.screenY;
        initialStageX.value = window.screenX;
        initialStageY.value = window.screenY;
      };

      const handleMouseMove = (e) => {
        if (isDragging.value && window.javaBridge) {
          const deltaX = e.screenX - startX.value;
          const deltaY = e.screenY - startY.value;

          window.javaBridge.moveWindow(
            initialStageX.value + deltaX,
            initialStageY.value + deltaY
          );
        }
      };

      const handleMouseUp = () => {
        isDragging.value = false;
      };

      // dps 풀링 시작
      const startPolling = () => {
        const initPolling = () => {
          if (window.dpsData && window.dpsData.getDpsData) {
            intervalId = setInterval(() => {
              if (!window.dpsData || !window.dpsData.getDpsData) {
                return;
              }

              const raw = window.dpsData.getDpsData();
              if (!raw || typeof raw !== "string") return;

              let {rows, targetName: newTargetName, battleTimeMs: _battleTimeMs} = buildRowsFromPayload(raw);
              const multiplier = isCollapse.value ? -1 : 1
              dpsDatas.value = rows.sort((a, b) =>
                multiplier * (Number(b.damageContribution || 0) - Number(a.damageContribution || 0)));
              targetName.value = newTargetName;
              battleTimeMs.value = _battleTimeMs;
            }, 200);
          } else {
            console.log("dpsData 없음");
          }
        };

        // 이미 준비되어 있으면 바로 실행
        if (window.dpsData) {
          initPolling();
        } else {
          console.log("javaReady 이벤트 대기 중...");

          window.addEventListener('javaReady', () => {
            console.log("javaReady 이벤트 수신!");
            initPolling();
          }, {once: true});
        }
      };

      const stopPolling = () => {
        if (intervalId) {
          clearInterval(intervalId);
          intervalId = null;
        }
      };

      // 배틀 시간 계산
      watch(battleTimeMs, (newVal) => {
        const now = Date.now();

        if (lastBattleTimeMs.value === null || lastBattleTimeMs.value !== newVal) {
          lastBattleTimeMs.value = battleTimeMs.value;
          lastChangedAt.value = now;
          fightState.value = "state-fighting";
        } else {
          const frozenMs = Math.max(0, now - lastChangedAt.value);

          if (frozenMs >= 30000) {
            fightState.value = "state-ended";
          } else if (frozenMs >= 10000) {
            fightState.value = "state-grace";
          } else {
            fightState.value = "state-fighting";
          }
        }
      }, {deep: true});

      window.addEventListener("nativeResetHotKey", () => {
        resetClick();
      });

      onMounted(() => {
        document.addEventListener("mousedown", handleMouseDown);
        document.addEventListener("mousemove", handleMouseMove);
        document.addEventListener("mouseup", handleMouseUp);
        startPolling();
      });

      onUnmounted(() => {
        document.removeEventListener("mousedown", handleMouseDown);
        document.removeEventListener("mousemove", handleMouseMove);
        document.removeEventListener("mouseup", handleMouseUp);
        stopPolling();
      });

      return {
        isCollapse,
        isDetailOpen,
        dpsDatas,
        targetName,
        detailRowId,
        fightState,
        battleTimeMs,
        lastBattleTimeMs,
        isSetting,
        resetClick,
        collapseClick,
        onClickUserRow,
        formatMMSS
      };
    },
    template: `
      <div class="meter">
        <HeaderArea :targetName="targetName" :isCollapse="isCollapse" @resetClick="resetClick"
                    @collapseClick="collapseClick" v-model:is-setting="isSetting"/>

        <MeterArea @onClickUserRow="onClickUserRow" :rows="dpsDatas"/>

        <div class="battleTime" :class="[fightState]" v-if="battleTimeMs != null">
          <div class="status" :data-state="fightState"></div>
          <div class="tick">{{ formatMMSS(battleTimeMs) }}</div>
        </div>
      </div>

      <DetailArea v-model:is-detail-open="isDetailOpen"
                  :id="detailRowId" :combatTime="formatMMSS(lastBattleTimeMs || 0)"/>

      <UpdateArea/>

      <SettingArea v-model:is-setting="isSetting"/>
    `
  });

  window.addEventListener('javaReady', () => {
    if (window.setupVueErrorHandler) {
      window.setupVueErrorHandler(app);
    }
  }, {once: true});

  app.mount('#app');
</script>
</body>
</html>
